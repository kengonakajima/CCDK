Shinra Development Station (SDS) 概要
====
Shinra Development Station (SDS) は、シンラのゲームプロジェクトを管理するためのツールです。
SDSの主な目的は、シンラのプロジェクトファイルを操作することです。

プロジェクトファイルは、ローカルでゲームをテストしたり、ゲームのパッケージを作成したり、
クラウドにデプロイしたりするために使います。


基本概念
----

SDSのGUIは3つの要素で構成されています。
![](../../docs/images/sds_gui.png)

画面上部にはメニューバーがあり、プロジェクトのセーブ、ロード、ゲームの開始、設定画面などを呼び出すことができます。

画面左側はプロジェクトツリーがあり、現在操作しているプロジェクトの情報を一覧できます。
プロジェクトは、データパックとスタートアップ設定を複数含むことができます。それらの内容については後述します。プロジェクトツリーの各要素をクリックすることで、右側の関連プロパティ画面を開くことができます。

画面右側の広い部分は、プロジェクトツリー内の現在選択されている要素に関連する詳細な設定情報を表示しています。


## SDS自体の設定

SDSツールそのものの設定は、メニューバーのSettingsから MCS configurationを選択することで確認できます(図)。
![](../../docs/images/sds_mcs_configuration.png)


**Python executable** は```python.exe```へのパスです。 Python 3が必要です。CCDKの開発では、3.4を使っています。

**Shinra script path**  は ```shinra.py```へのパスです。　このスクリプトは、SDSの内部的に使われているもので、パッケージの作成や、ゲームのインストール、実行などを行います。デフォルトでは、SDSがあるディレクトリのサブディレクトリに格納されています。

**Shinra MCS path** はMCSのSDS以外のDLLなどのファイル群が格納されているディレクトリの位置です。通常MCSはSDSと同じ圧縮ファイルで提供されるので、SDSがあるディレクトリをそのまま指定するのでかまいません。　SDSはパッケージを作成する際に、このディレクトリからDLLをコピーするなどしてパッケージを完成させます。

**Games installation dir** は、SDSがローカル環境に対してゲームをインストールする際に使う作業用のディレクトリで、プロジェクトごとに個別のディレクトリが、ここで指定するディレクトリの中に作られます。ゲームデータ全体のコピーが含まれるので、十分な容量が必要です。

**Default game user id** シンラ・クライアントから接続するときに必要なユーザー名のデフォルト値を指定します。

**Force overwriting of game data on install** のチェックを外した状態にしておくと、ゲームに必要なファイルのうち、実際に変更されたもの(サイズか日付が異なるもの)だけがコピーされます。デフォルトではチェックは無しです。　これによって、大きいデータをもつゲームのインストール時間を短縮することができます。


## シンラ・プロジェクトの構成
シンラ・プロジェクトは、**データパック**と **スタートアップ設定**の2つの部分からなります。またオプションとして、 **レポートシステム**も利用可能です。


データパックは、ゲームの動作に必要なファイルやディレクトリの構成を定義します。
スタートアップ設定は、ゲームをどのように起動するのか、またMCSの設定をどうするのかを定義します。

スタートアップ設定におけるファイルの位置は、データパック内のルートディレクトリからの相対で指定します。そのため有効なスタートアップ設定にはデータパック(複数をプロジェクトに含めることができる)を特定する必要があります。

典型的な手順ではまずデータパックを定義し、次にスタートアップ設定を定義します。その際には、データパックに含まれる実行ファイル(exeファイル)を起動ファイルとして指定します。

設定の具体例については　[Setup.ja.md](Setup.ja.md) も参考にしてください。


### データパックを作る

シンラ・プロジェクトに含まれるデータパックは、データの位置を指定するだけで、
データ自体は含みません。データ自体が含まれた状態にするには、シンラ・パックを作成する必要があります。それは後述します。

以下の3つの方法でデータパックを作ることができます。

- ```Project```メニューから ```Add data pack```をクリックする。
- プロジェクトツリーの```Data packs```を右クリックして、 ```Add data pack```を選択する
- エクスプローラから、プロジェクトツリーにディレクトリをドラッグ&ドロップする。

データパックを作ると、以下の項目が設定可能になります。

![](../../docs/images/sds_add_datapack.png)

- **Id** ほかのデータパックと区別するためのID。　任意の文字列を指定します。
- **Version**  データパックを追跡するためのバージョン番号です。デバッグに活用します。
- **Directory** データをコピーする元になるディレクトリの位置を指定します。
- **Alias** データが実際に展開されるディレクトリの名前を指定します。デフォルトではこれはコピー元のディレクトリと同じ名前になりますが、任意の名前を設定することができます。

### スタートアップ設定を作る

以下の3つの方法でスタートアップ設定を作成できます。

- ```Proejct```メニューで、 ```Add Startup configuration```をクリックする。
- プロジェクトツリーで```Startup configurations``` を右クリックし、```Add Startup configuration```を選択する
- 各データパックのファイルリストで、実行可能ファイルで右クリックし、```Add startup configuration```を選択する

![](../../docs/images/sds_add_startup.png)

スタートアップ設定を追加したら、以下の項目が設定できます。


- **Id** 他のスタートアップ設定と区別するためのID。自由な文字列を入力します。
- **Executable** データパック内の実行可能ファイルのパス(ルートからの相対)。
- **Arguments** 実行するときのコマンドライン引数
- **Work directory** 実行するときのワークディレクトリ(ルートからの相対)。
- **Data pack** 使用するデータパック。プロジェクト内で定義している必要があります。
- **Save data** ゲームサーバのプログラムが終了したときに自動的にセーブするファイルを指定します。　ファイルのパスをフィルタするための記述のリストか、ファイルフックを書きます。　次に同じユーザがこのゲームを実行したときに前回セーブされたファイルが自動的に書き込まれます。ゲームのセーブデータをこれによって簡単に実装できます。
- **Temp data** 一時データの位置。ゲームサーバのプログラムが終了したときに、ここで指定したパス(またはファイルフック)にあるファイルやディレクトリは、自動的に削除されます。
- **Custom properties** CloudPropertiesファイルに値を設定します。特定の古いゲームで必要なオプションを設定するために主に使われます。 設定可能な項目については、 [MCS_README](MCS_README_ja.md#CloudProperties)を参照してください。


データパックのプレビューウインドウからテキストフィールドにファイルをドロップすると便利です。また、2つ以上のスタートアップ設定をひとつの実行ファイルに割り当てることもできます。

### プロジェクトのパッケージ化

SDSを使ってプロジェクトをパッケージすることができます。
このパケージはデータパックと、ゲームをシンラサーバーにデプロイするために必要な情報を含みます。シンラサーバーだけでなく、ほかの開発マシンにこのパッケージをデプロイすることも可能です。

*Project* メニューから *Build ShinraPack* を選択してパッケージを作成できます。

### プロジェクトのインポート

パッケージ化されたプロジェクトは、　新しいプロジェクトを作成するために再度インポートすることができます。

インポートするには、 *File* メニューをクリックして、 *Import project* をクリックします。　すると必要な情報を入力するためのダイアログが表示されます。

以下を指定してください。


- *Import from package* : パッケージ化されたプロジェクトを含むZIPファイル名
- *Store data in* 取り出されたデータを格納する、出力先ディレクトリ名
- *Project file* プロジェクトファイル名 (拡張子.shinra)


### レポート機能

SDS を設定して、バグレポート管理システムと連携させることができます。

レポートの設定は、2つの部分からなります:

- SDSの設定。 レポートを作成するときに呼び出すコマンドを定義します。それぞれのレポートコマンドに対して、プロジェクトの側で設定されるべき一連の変数を定義します。
- プロジェクトごとの設定。　どのレポートコマンドを使うか、また、それぞれのレポートコマンドごとに必要になる変数の内容を定義します。


#### レポートコマンドの設定

レポートシステムを追加するためには、 'ReportCommands'セクションを、
ファイル `%AppData%/Shinra/SDS/Settings.json` に追加します。

次のJSONテキストはgithubのissueを新しく発行する際の設定例です:

現在では、SDSはこの値を編集するためのGUIを持っていないため、
外部のエディタを用いて編集作業をする必要があります。


```
{
  "ReportCommands": {
    "github": {
      "Command": "{ProjectURL}/issues/new?title={Title}&body={Body}",
      "Type": "url",
      "Variables": {
        "ProjectURL": {
          "Default": "https://github.com/user/project",
          "UrlEscape": false,
          "Multiline": false
        },
        "Title": {
          "Default": "[{GameId}]",
          "UrlEscape": true,
          "Multiline": false
        },
        "Body": {
          "Default": "GameId={GameId}\nUserId={UserId}\nVideoPort={VideoPort}\nGamePort={GamePort}\n",
          "UrlEscape": true,
          "Multiline": true
        }
      }
    }
  }
}
```

各項目の意味は以下の通りです :

- **ReportCommands**: レポートコマンドのルートとなるプロパティ。
- **ReportCommands.[commandId]**: それぞれのコマンドは一意なIDによって区別されます。このIDは、プロジェクト内部で重複していない必要があります。
- **ReportCommands.[commandId].Command**: 問題をレポートする際に実行するコマンドラインの文字列。 デフォルトブラウザに与えるURLも指定することができます。
- **ReportCommands.[commandId].Type** : コマンドのタイプ。 "url"を指定すると、Commandの文字列はURLと認識され、デフォルトブラウザを用いて開かれます。 "command" を指定するとWindowsのコマンドラインとして実行されます。[ゲームインスタンス変数](#GameInstanceVariable) が環境変数として定義されるので、スクリプトなどからそれを利用できます。
- **ReportCommands.[commandId].Variables**: コマンドによって必要とされる変数のリストを定義するためのルートとなるプロパティ。ここでリストされる変数は、各プロジェクトで定義される必要があります。
- **ReportCommands.[commandId].Variables.[variableName].Default**: 変数のデフォルト値
- **ReportCommands.[commandId].Variables.[variableName].UrlEscape**: 変数の値を実際に送信する前にURLエスケープをする必要があるかを指定するブール値
- **ReportCommands.[commandId].Variables.[variableName].Multiline**: ププロジェクトの変数値を入力させるUIにおいて、複数行に対応したGUIを表示するかどうかを指定するブール値

#### Projectにおけるレポート設定

プロジェクトの側では、 SDSのユーザーインターフェイスを用いて、どのレポートコマンドを使うかを選択し、またそれぞれのレポートコマンドごとに必要になる変数の値を入力します。

変数の内容を設定するときには、[ゲームインスタンス変数](#GameInstanceVariable)を使えます。
また変数は互いを参照することはできません。

下記は、プロジェクトファイルにおけるレポート用の設定の例です。

```
{
  "reportConfig": {
    "Id": "github",
    "Variables": {
      "ProjectURL": "https://github.com/username/projectname",
      "Title": "[{GameId}]",
      "Body": "GameId={GameId}\nUserId={UserId}\nVideoPort={VideoPort}\nGamePort={GamePort}\n"
    }
  }
}
```



### <a name="GameInstanceVariable"></a> ゲームインスタンス変数

レポートのコマンドラインを定義するときと、レポート用の変数を定義するときには、
以下のいくつかの変数を使えます。変数名を中括弧で囲むことで自動的に内容が置換されます。


- ```{GameId}``` : ゲームインスタンスのゲームID
- ```{UserId}``` : 現在プレイしているユーザーのID
- ```{VideoPort}``` : 使用されているビデオポート番号
- ```{GamePort}``` : 使用されているゲームポート番号
- ```{GameDumpPath}``` : ゲームがクラッシュした場合は、minidumpファイル(.mdmp)のパス。クラッシュしなかった場合の値は空
- ```{UserDataPath}``` : ゲームのセーブデータアーカイブへのパス
- ```{UserLogsPath}``` : ユーザーのエラーログファイルへのパス。ユーザー単位であり、ゲーム単位ではないことに注意
- ```{ExitCode}``` : ゲームの終了コード


## MCS
MCSは、ゲームをローカルで実行するときに内部的に使用されるツールです。
SDSは MCSを設定したり、シンラプロジェクトのゲームをインストールしたり実行したりするための使いやすいUIを提供します。


### MCSの設定

SDSのインターフェイスを用いてMCSの設定を変更できます。
*Settings* メニューの *MCS Configuration* をクリックすると、
MCSの設定画面が表示されます。

各項目の設定内容は、以下の通りです :

- **Shinra MCS path** MCSのパッケージが配置されているディレクトリ名。 CCDKの場合は、通常 CCDK/mcs です。 このディレクトリには、レンダラのエミュレーションに必要なDLLや各種の実行ファイルなどが含まれます。SDSは、ゲームを実行するために必要なリンクや設定ファイルを自動生成します。

- **User data work dir** ゲームを実行するときに使用するユーザーデータの保存先となるルートディレクトリの名称を指定します。 MCSがユーザーデータをどのように扱うかについては、 [MCS READMEのファイルフック](MCS_README.html#FileHooks) の項目を参照してください。 書き込み権限を持っていることや、ユーザーデータをコピーできるだけのディスクの空き容量についても注意が必要です。

- **User data archive dir** ゲームを終了させてから次に起動するまでの間にユーザーデータを永続化しておくアーカイブのルートディレクトリ名を指定します。 MCSがユーザーデータをどのように扱うかについては、[MCS READMEのファイルフック](MCS_README.html#FileHooks) の項目を参照してください。書き込み権限を持っていることや、セーブデータを受け入れるに足るディスクの空き容量についても注意が必要です。

- **Games installation dir** ゲームのファイルをローカルにデプロイし、実行する際のルートディレクトリを指定します。 書き込み権限を持っていることや、ゲームの画像や音声を含むデータ全体をコピーすることができるディスク容量に注意をしてください。

- **Configuration** DebugまたはReleaseのどちらのバージョンのDLLを使用するかを設定します。 CCDKと一緒に配布されているのはReleaseビルドされたものです。

- **Force overwriting of game data on install** がチェックされていない場合は、ゲームを再インストールするときには、変更があったファイル(サイズまたは日付)だけが上書きされます。これは不要なコピーを減らしてデプロイの高速化をするためです。チェックをすると、強制的にすべてをコピーするようになります。

- **Cleanup unused files on install** チェックしておくと、インストールすると、データパックに含まれていないファイルをすべて削除します。


- **Local execution options** MCSのパラメータチューニングをするために使う設定項目です。 [MCS READMEの 設定オプション](MCS_README.html#Properties) の項目を参照してください。  ここでの設定はMCSによるローカル実行に関するもののみで、シンラサーバーにデプロイしての実行にはまったく関係がないことに注意が必要です。

MCSの設定状態は、ファイル  ```%APPDATA%/Shinra/SDS/Settings.json.``` に格納されていて、テキストファイルで見ることができます。


### ゲームを実行開始する

2つの方法でゲームを開始できます。

- メニューの```Project```から、 ```Start game```を選択して、開始したいスタートアップ設定を選択します。
- プロジェクトツリーから、開始したいスタートアップ設定を右クリックし、 ```Start game``` を選択します。

ゲームを始めると、SDS自体に設定されたゲームのインストールディレクトリ ```Games installation dir``` の中にゲームがコピーされ、必要なDLLなどが自動的にインストールされ、そこでゲームが開始されます。
インストールが完了すると、ゲームの実行管理ウインドウが表示されます。

When starting a game, the game data will be deployed in the directory specified under the "MCS configuration", and then executed there. Once the installation is over you will be prompted the Game running window.

### ゲームの実行管理ウインドウ

プロジェクトメニューから ```Start game```を選択すると以下のようなウインドウが表示されます。

![](../../docs/images/sds_two_instances.png)

ひとつのスタートアップ設定から、複数のゲームを起動することができます。
このウインドウでは1行がひとつのゲームの実行インスタンスに対応します。
インスタンスとはWindowsにおけるゲームサーバのプロセスひとつのことです。
たとえば3人でのマルチプレイを試したい場合は、インスタンスが3つ、この設定が3行必要です。

それぞれの行に表示されている内容は以下の通りです。


- **User id** インスタンスで使われるユーザーのIDを指定します。複数のインスタンスでひとつのユーザーIDを共有することはできません。それぞれ異なるユーザーIDを指定してください。
- **Game port** ゲームポートのTCPポート番号を指定します。ゲームポートとは、シンラ・クライアントからゲームサーバに対して操作情報を送るためのTCPポートです。このポート番号はほかのプログラムによって占有されていない必要があります。
- **Video port** ビデオポートのTCPポート番号を指定します。ビデオポートとは、シンラ・クライアントが映像データを受信するためのTCPポートです。このポート番号はほかのプログラムによって占有されていない必要があります。
- **Game** ゲームを開始/停止するボタンです。インスタンスに設定されたユーザーIDやポート番号などの設定をともなってゲームを開始します。　ゲームを開始できる状態のときは ```Start``` 、一旦開始すると　```Stop``` ボタンに変わります。
- **Client** シンラ・クライアント(ビデオビューワ)を開始するボタンです。インスタンスに設定されたゲームポートとビデオポートの設定を使って適切にクライアントを設定して起動します。デフォルトでは、ゲームを起動すると自動的にクライアントも起動します。ほかのコンピュータから接続してテストプレイしたい場合は、このオプションをはずしてください。

- **Create issue** レポート設定があるときだけ有効になるボタンです。プロジェクトに関する問題をレポートするにはこのボタンをクリックします。レポートの変数は、ゲームのインスタンスごとに定義されます。エラー終了コードを返したゲームを自動的にレポートするには、 "create on game error" チェックボックスを有効にしておきます。


インスタンスのリストの空白部分部分で右クリックし、 ```Add game instance```を選択すると、新しいインスタンスを追加することができます。また、インスタンスを選択してdeleteキーを押すことでインスタンスを削除できます。


## SCC

Shinra Command Center (SCC) は、シンラのクラウドサービス上でゲームをデプロイしたり操作したりするためのHTTP RESTサービスです。

SDSはSCCに接続して各種のタスクを実行したり状態を監視します。


### SCCの設定

MCSがSCCにアクセスする際の設定は、 **Settings**から **SCC Configuration**をクリックし、設定ダイアログを表示します。


- **Server URL** SDSが使うSCCサービスのHTTP URL

- **Proxy URL** HTTP経由でアクセスをする際に使うプロクシのURL。 デフォルトではSDSはWindowsのデフォルトに設定されたプロクシを使いますが、ここでSDS専用のプロクシを設定できます。

- **Refresh time** サーバーで動作しているVMの状態を自動更新する時間の間隔を設定します。 SDSのUIは定期的にサーバーを監視して状態を更新します。0にすると自動更新を停止できます。


### VMの予約
シンラのサーバーにゲームをデプロイして実行するには、バーチャルマシン(VM)の予約が必要です。
予約をするには、正しく設定されたプロジェクトが必要です。そのプロジェクトは、 有効な 'ContentId'と 'ApiKey'を含んでいる必要があります。

*Project* メニューの*SCC management*をクリックし、VMを操作するダイアログを表示します。

もし、予約が待たされている状態であれば、あとどれほどの時間で予約したVMが利用可能になるのかが表示されます。　もし現在予約できていれば、予約が切れるまでの時間の長さが表示されます。

新しいVMの枠を予約をするには、 *New*をクリックします。　すると次の24時間以内で空いている枠に割り当てられます(あれば)。　予約の枠を削除することもできます。

現時点では、同時に1つの枠を予約することしかできません。


### プロジェクトをアップロードする

プロジェクトをアップロードするには、`ContentId` と `ApiKey` と有効な SCC 設定を追加して、プロジェクトを完成させる必要があります。

また、実際にサーバーにゲームをアップロードする前に、MCSを利用してゲームの動作確認をローカルで行っておくことが強く推奨されます。

アップロードのプロセスは、かなり長い時間がかかる場合があります。
アップロードには3つの段階があり、それぞれにかかる時間はプロジェクトのサイズによって変化します:

- **Package building.**  新しいパッケージファイルをアップロード用にビルドしています。
- **Package upload.** パッケージファイルをSCCに対してHTTP経由でアップロードしています。
- **Package installation.** SCCがパッケージファイルを受信した後、サーバーを初期化しています。　新しいVMが作られ、データを展開します。　VMの状態は "intalling"に変わります。

### VMを起動する

プロジェクトがアップロードされインストールされたら、VMは"ready"状態になります。
こうなれば、 *Start*ボタンを押してVMを起動できます。

*Clients password* フィールドによって、クライアントがゲームサーバーに接続する際にパスワード入力を要求するようにできます。
デフォルトではパスワード要求は無しで、IPアドレスとポート番号を知っていれば、
誰でも無制限に接続をすることが可能です。
パスワードを設定することによってこれを制限できます。
このパスワードは、VMを開始するときだけ設定可能です。
もしVM起動中にパスワードを変更したい場合は、VMを一旦止めて再起動する必要があります。

*Start*をクリックすると、VMは "starting"状態になり、システムが起動中であることがわかります。 VMの起動処理が終わると、 "running"に変化します。
この段階になると、接続のための情報(IPアドレスとポート)も表示されるので、
クライアントを起動してゲームをプレイすることができます。


### VMを停止する

VMが "running"状態のときは、 *Stop*ボタンを押すことでVMを停止できます。
これによってVMは停止され、すべてのゲームインスタンスも停止します。

停止処理が終わると "ready"状態に戻ります。

VMの動作ログをダウンロードするためのリンクが使えるようになります。


### クライアントの手動起動

VMが "running"状態のときは、ゲームサーバーのIPアドレスとポート番号が表示されています。
この情報を用いて、クライアントを手動起動して、ゲームをプレイできます。
サーバーにパスワードが設定されている場合は、それをコマンドラインで指定することで入力を省略できます。

次の例は、IPアドレス 192.34.56.88, ポート番号 16666　を用いて、パスワードとして
`MYPASS` を設定している場合のWindowsコマンドラインです:

```
ShinraClient.exe -sa MYPASS http://192.34.56.88:16666/runLauncher/gameId
```


### SCC FAQ

1. <a name="FAQ1"></a>C++で制作したゲームが、デバッグビルドではVM上で動かない。

VC++のデバッグライブラリは、通常はコンパイラのバージョンに紐付けられており、配布ができません。
この問題を修正するためには、実行ファイル(EXE)と同じディレクトリに、デバッグライブラリへのリンクを配置することを推奨します。VC++のランタイムデバッグライブラリは、通常 Visual Studioのインストールディレクトリの 'VC/redist/Debug_NonRedist'に配置されています。


